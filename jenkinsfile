// for backup and cleanup 

pipeline {

    agent none

    parameters {
        booleanParam(name: 'backup_db', defaultValue: true, description: 'Run backup_db')
        booleanParam(name: 'backup_files', defaultValue: true, description: 'Run backup_files')
        booleanParam(name: 'send_sftp', defaultValue: true, description: 'Run send_sftp')
        booleanParam(name: 'cleanup', defaultValue: true, description: 'Run cleanup')
        booleanParam(name: 'remove_nextcloud_backups', defaultValue: true, description: 'Run remove_nextcloud_backups')
    }
    
    stages {
        stage('DB_backup') {
            when { expression { return params.backup_db } }
            agent { label 'nextcloud-home' }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'gnome-terminal']) {
                    sh '/home/jenkins/Nextcloud/db_backups.sh'
                }
            }
        }
        stage('Files_backup') {
            when { expression { return params.backup_files } }
            agent { label 'nextcloud-home' }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'gnome-terminal']) {
                    sh '/home/jenkins/Nextcloud/files_backup.sh'
                }
            }
        }
        stage('Sending_to_SFTP') {
            when { expression { return params.send_sftp } }
            agent { label 'nextcloud-home' }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'gnome-terminal']) {
                    sh '/home/jenkins/Nextcloud/send_sftp.sh'
                }
            }
        }
        stage('Container_VM_cleanup') {
            when { expression { return params.cleanup } }
            agent { label 'nextcloud-home' }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'gnome-terminal']) {
                    sh '/home/jenkins/Nextcloud/cleanup.sh'
                }
            }
        }
        stage('SFTP_cleanup') {
            when { expression { return params.remove_nextcloud_backups } }
            agent { label 'SFTP' }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'gnome-terminal']) {
                    sh 'sudo /home/jenkins/scripts/remove_nextcloud_backups.sh'
                }
            }
        }
    }
}